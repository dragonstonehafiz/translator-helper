<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="header-container">
    <h1>Context</h1>
    <span class="tooltip-icon" title="Upload a subtitle file (.ass or .srt) and the app will automatically use the selected OpenAI API to generate context for translations">?</span>
  </div>

  <div class="form-section">
    <!-- File Download/Upload Section -->
    <app-subsection 
      title="File Download/Upload" 
      [collapsed]="fileUploadCollapsed"
      tooltip="Import and export context data, and upload subtitle files for processing">
      
      <!-- Import/Export Context -->
      <div class="section-header">
        <h3>
          Import/Export Context
          <span class="info-icon" title="Save your context to a JSON file for future use, or load a previously saved context">?</span>
        </h3>
      </div>
      
      <app-file-upload
        accept=".json"
        placeholder="Import Context"
        subtext=".json"
        [selectedFiles]="importFile ? [importFile] : []"
        (filesSelected)="onImportFilesSelected($event)">
      </app-file-upload>
      <button class="action-button" (click)="exportContext()">Export Context</button>

      <!-- Subtitle File Upload -->
      <div class="section-header">
        <h3>
          Subtitle File Upload
          <span class="info-icon" title="Upload subtitle files (.ass or .srt) to be used for context generation">?</span>
        </h3>
      </div>
      <div class="form-row">
        <div class="form-group">
          <div class="label-container">
            <label for="inputLanguage">Input Language</label>
            <span class="info-icon" title="Language of the subtitle file to be processed">?</span>
          </div>
          <select id="inputLanguage" [(ngModel)]="inputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>

        <div class="form-group">
          <div class="label-container">
            <label for="outputLanguage">Output Language</label>
            <span class="info-icon" title="Target language for translations and context generation">?</span>
          </div>
          <select id="outputLanguage" [(ngModel)]="outputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
      </div>
      <app-file-upload
        accept=".ass,.srt"
        placeholder="Upload Subtitle File"
        subtext=".ass / .srt"
        [selectedFiles]="selectedFile ? [selectedFile] : []"
        (filesSelected)="onSubtitleFilesSelected($event)">
      </app-file-upload>
    </app-subsection>

    <app-subsection 
      title="Context" 
      [collapsed]="contextCollapsed"
      tooltip="Generate and manage translation context including web research, character lists, summaries, and recaps">
      
      <!-- Web Search -->
      <div class="section-header">
        <h3>
          Web Search
          <span class="info-icon" title="Gather contextual information from web search using series name and keywords">?</span>
        </h3>
      </div>
      <div class="form-row">
        <div class="form-group">
          <div class="label-container">
            <label for="seriesName">Series Name</label>
            <span class="info-icon" title="Used for gathering context from web search">?</span>
          </div>
          <input type="text" id="seriesName" [(ngModel)]="seriesName" placeholder="Enter series name...">
        </div>

        <div class="form-group">
          <div class="label-container">
            <label for="keywords">Keywords</label>
            <span class="info-icon" title="Used for gathering context from web search">?</span>
          </div>
          <input type="text" id="keywords" [(ngModel)]="keywords" placeholder="Enter keywords...">
        </div>
      </div>

      <button class="action-button" (click)="gatherWebContext()" [disabled]="runningContext">Gather Web Context</button>

      <div class="form-group">
        <app-text-field 
          label="Gathered Web Context" 
          placeholder="Web context will appear here..."
          [(ngModel)]="webContext"
          (ngModelChange)="updateWebContext()">
        </app-text-field>
      </div>

      <!-- Character List -->
      <div class="form-group">
        <app-text-field 
          label="Character List" 
          tooltip="Generate a list of characters with descriptions from the subtitle file"
          placeholder="Enter character names and descriptions..."
          [(ngModel)]="characterList"
          (ngModelChange)="updateCharacterList()">
        </app-text-field>
      </div>

      <div class="context-options">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="characterListUseWebContext">
          <span>Include Web Context</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="characterListUseSummary">
          <span>Include Summary</span>
        </label>
      </div>
      <button class="action-button" (click)="generateCharacterList()" [disabled]="runningContext">Generate Character List</button>

      <!-- Synopsis -->
      <div class="form-group">
        <app-text-field 
          label="Synopsis" 
          tooltip="Generate a synopsis of the episode or scene"
          placeholder="Enter synopsis..."
          [(ngModel)]="synopsis"
          (ngModelChange)="updateSynopsis()">
        </app-text-field>
      </div>

      <div class="context-options">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="synopsisUseWebContext">
          <span>Include Web Context</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="synopsisUseCharacterList">
          <span>Include Character List</span>
        </label>
      </div>
      <button class="action-button" (click)="generateSynopsis()" [disabled]="runningContext">Generate Synopsis</button>

      <!-- Summary -->
      <div class="form-group">
        <app-text-field 
          label="Summary" 
          tooltip="Generate a high-level summary of the episode or content"
          placeholder="Enter summary..."
          [(ngModel)]="summary"
          (ngModelChange)="updateSummary()">
        </app-text-field>
      </div>

      <div class="context-options">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="summaryUseWebContext">
          <span>Include Web Context</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="summaryUseCharacterList">
          <span>Include Character List</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="summaryUseSynopsis">
          <span>Include Synopsis</span>
        </label>
      </div>
      <button class="action-button" (click)="generateSummary()" [disabled]="runningContext">Generate Summary</button>
    </app-subsection>

    <app-subsection 
      title="Recap" 
      [collapsed]="recapCollapsed"
      tooltip="Generate a comprehensive recap from multiple context files for continuity across episodes">
      
      <app-file-upload
        accept=".json"
        [multiple]="true"
        placeholder="Upload Context Files"
        subtext=".json files (select multiple)"
        [selectedFiles]="recapContextFiles"
        (filesSelected)="onRecapFilesSelected($event)">
      </app-file-upload>

      <div class="file-table-container" *ngIf="recapContextFiles.length > 0">
        <div class="file-table-header">
          <span>Uploaded Context Files</span>
          <span class="info-icon" title="Files are processed in the order shown. Use ↑/↓ buttons to reorder them for proper chronological sequence.">?</span>
        </div>
        <table class="file-table">
          <thead>
            <tr>
              <th class="col-reorder"></th>
              <th class="col-index">#</th>
              <th class="col-filename">Filename</th>
              <th class="col-remove"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let file of recapContextFiles; let i = index">
              <td class="col-reorder">
                <div class="reorder-buttons">
                  <button type="button" 
                          class="reorder-btn" 
                          (click)="moveRecapFileUp(i)" 
                          [disabled]="i === 0"
                          title="Move up">↑</button>
                  <button type="button" 
                          class="reorder-btn" 
                          (click)="moveRecapFileDown(i)" 
                          [disabled]="i === recapContextFiles.length - 1"
                          title="Move down">↓</button>
                </div>
              </td>
              <td class="col-index">{{ i + 1 }}</td>
              <td class="col-filename">{{ file.name }}</td>
              <td class="col-remove">
                <button type="button" class="remove-btn" (click)="removeRecapFile(i)" title="Remove file">✕</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="action-button" (click)="generateRecap()" [disabled]="runningContext || recapContextFiles.length === 0">Generate Recap</button>

      <div class="form-group">
        <app-text-field 
          label="Generated Recap" 
          placeholder="Recap will appear here..."
          [(ngModel)]="recap">
        </app-text-field>
      </div>
    </app-subsection>
  </div>
</div>

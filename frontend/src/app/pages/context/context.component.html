<app-sidebar></app-sidebar>

<div class="page-container">
  <div class="header-container">
    <h1>Context</h1>
    <span class="tooltip-icon" title="Upload a subtitle file (.ass or .srt) and the app will automatically use the selected OpenAI API to generate context for translations">?</span>
  </div>

  <div class="form-section">
    <!-- Import/Export Section -->
    <app-subsection 
      title="Import/Export" 
      [collapsed]="importExportCollapsed"
      tooltip="Save your context to a JSON file for future use, or load a previously saved context">
      <app-file-upload
        accept=".json"
        placeholder="Import Context"
        subtext=".json"
        [selectedFiles]="importFile ? [importFile] : []"
        (filesSelected)="onImportFilesSelected($event)">
      </app-file-upload>
      <button class="action-button" (click)="exportContext()">Export Context</button>
    </app-subsection>

    <app-subsection 
      title="File Upload" 
      [collapsed]="fileUploadCollapsed"
      tooltip="Upload subtitle files (.ass or .srt) to be used for context generation">
      <div class="form-row">
        <div class="form-group">
          <div class="label-container">
            <label for="inputLanguage">Input Language</label>
            <span class="info-icon" title="Language of the subtitle file to be processed">?</span>
          </div>
          <select id="inputLanguage" [(ngModel)]="inputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>

        <div class="form-group">
          <div class="label-container">
            <label for="outputLanguage">Output Language</label>
            <span class="info-icon" title="Target language for translations and context generation">?</span>
          </div>
          <select id="outputLanguage" [(ngModel)]="outputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
      </div>
      <app-file-upload
        accept=".ass,.srt"
        placeholder="Upload Subtitle File"
        subtext=".ass / .srt"
        [selectedFiles]="selectedFile ? [selectedFile] : []"
        (filesSelected)="onSubtitleFilesSelected($event)">
      </app-file-upload>
    </app-subsection>

    <app-subsection 
      title="Web Search" 
      [collapsed]="webContextCollapsed"
      tooltip="Gather contextual information from web search using series name and keywords">
      <div class="form-row">
        <div class="form-group">
          <div class="label-container">
            <label for="seriesName">Series Name</label>
            <span class="info-icon" title="Used for gathering context from web search">?</span>
          </div>
          <input type="text" id="seriesName" [(ngModel)]="seriesName" placeholder="Enter series name...">
        </div>

        <div class="form-group">
          <div class="label-container">
            <label for="keywords">Keywords</label>
            <span class="info-icon" title="Used for gathering context from web search">?</span>
          </div>
          <input type="text" id="keywords" [(ngModel)]="keywords" placeholder="Enter keywords...">
        </div>
      </div>

      <button class="action-button" (click)="gatherWebContext()" [disabled]="runningContext">Gather Web Context</button>

      <div class="form-group">
        <div class="textarea-header">
          <label for="webContext">Gathered Web Context</label>
          <div class="font-size-controls">
            <button type="button" class="mode-toggle-btn" (click)="toggleWebContextMode()" title="Toggle read/edit mode">
              {{ webContextReadMode ? 'Read Mode' : 'Write Mode' }}
            </button>
            <button type="button" class="font-size-btn" (click)="adjustWebContextFontSize(-1)" title="Decrease font size">A-</button>
            <span class="font-size-display">{{ webContextFontSize }}px</span>
            <button type="button" class="font-size-btn" (click)="adjustWebContextFontSize(1)" title="Increase font size">A+</button>
          </div>
        </div>
        <textarea *ngIf="!webContextReadMode" id="webContext" [(ngModel)]="webContext" (ngModelChange)="updateWebContext()" rows="8" placeholder="Web context will appear here..." [style.font-size.px]="webContextFontSize"></textarea>
        <div *ngIf="webContextReadMode" class="markdown-view" [innerHTML]="formatMarkdown(webContext)" [style.font-size.px]="webContextFontSize"></div>
      </div>
    </app-subsection>

    <app-subsection 
      title="Context" 
      [collapsed]="contextCollapsed"
      tooltip="Generate character lists and summaries from uploaded subtitle files using AI">
      <div class="form-group">
        <div class="textarea-header">
          <label for="characterList">Character List</label>
          <div class="font-size-controls">
            <button type="button" class="mode-toggle-btn" (click)="toggleCharacterListMode()" title="Toggle read/edit mode">
              {{ characterListReadMode ? 'Read Mode' : 'Write Mode' }}
            </button>
            <button type="button" class="font-size-btn" (click)="adjustCharacterListFontSize(-1)" title="Decrease font size">A-</button>
            <span class="font-size-display">{{ characterListFontSize }}px</span>
            <button type="button" class="font-size-btn" (click)="adjustCharacterListFontSize(1)" title="Increase font size">A+</button>
          </div>
        </div>
        <textarea *ngIf="!characterListReadMode" id="characterList" [(ngModel)]="characterList" (ngModelChange)="updateCharacterList()" rows="8" placeholder="Enter character names and descriptions..." [style.font-size.px]="characterListFontSize"></textarea>
        <div *ngIf="characterListReadMode" class="markdown-view" [innerHTML]="formatMarkdown(characterList)" [style.font-size.px]="characterListFontSize"></div>
      </div>

      <div class="context-options">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="characterListUseWebContext">
          <span>Include Web Context</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="characterListUseSummary">
          <span>Include Summary</span>
        </label>
      </div>
      <button class="action-button" (click)="generateCharacterList()" [disabled]="runningContext">Generate Character List</button>

      <div class="form-group">
        <div class="textarea-header">
          <label for="summary">Summary</label>
          <div class="font-size-controls">
            <button type="button" class="mode-toggle-btn" (click)="toggleSummaryMode()" title="Toggle read/edit mode">
              {{ summaryReadMode ? 'Read Mode' : 'Write Mode' }}
            </button>
            <button type="button" class="font-size-btn" (click)="adjustSummaryFontSize(-1)" title="Decrease font size">A-</button>
            <span class="font-size-display">{{ summaryFontSize }}px</span>
            <button type="button" class="font-size-btn" (click)="adjustSummaryFontSize(1)" title="Increase font size">A+</button>
          </div>
        </div>
        <textarea *ngIf="!summaryReadMode" id="summary" [(ngModel)]="summary" (ngModelChange)="updateSummary()" rows="8" placeholder="Enter summary..." [style.font-size.px]="summaryFontSize"></textarea>
        <div *ngIf="summaryReadMode" class="markdown-view" [innerHTML]="formatMarkdown(summary)" [style.font-size.px]="summaryFontSize"></div>
      </div>

      <div class="context-options">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="summaryUseWebContext">
          <span>Include Web Context</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="summaryUseCharacterList">
          <span>Include Character List</span>
        </label>
      </div>
      <button class="action-button" (click)="generateSummary()" [disabled]="runningContext">Generate Summary</button>
    </app-subsection>

    <app-subsection 
      title="Recap" 
      [collapsed]="recapCollapsed"
      tooltip="Generate a comprehensive recap from multiple context files for continuity across episodes">
      <app-file-upload
        accept=".json"
        [multiple]="true"
        placeholder="Upload Context Files"
        subtext=".json files (select multiple)"
        [selectedFiles]="recapContextFiles"
        (filesSelected)="onRecapFilesSelected($event)">
      </app-file-upload>

        <div class="file-table-container" *ngIf="recapContextFiles.length > 0">
          <div class="file-table-header">
            <span>Uploaded Context Files</span>
            <span class="info-icon" title="Files are processed in the order shown. Use ↑/↓ buttons to reorder them for proper chronological sequence.">?</span>
          </div>
          <table class="file-table">
            <thead>
              <tr>
                <th class="col-reorder"></th>
                <th class="col-index">#</th>
                <th class="col-filename">Filename</th>
                <th class="col-remove"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let file of recapContextFiles; let i = index">
                <td class="col-reorder">
                  <div class="reorder-buttons">
                    <button type="button" 
                            class="reorder-btn" 
                            (click)="moveRecapFileUp(i)" 
                            [disabled]="i === 0"
                            title="Move up">↑</button>
                    <button type="button" 
                            class="reorder-btn" 
                            (click)="moveRecapFileDown(i)" 
                            [disabled]="i === recapContextFiles.length - 1"
                            title="Move down">↓</button>
                  </div>
                </td>
                <td class="col-index">{{ i + 1 }}</td>
                <td class="col-filename">{{ file.name }}</td>
                <td class="col-remove">
                  <button type="button" class="remove-btn" (click)="removeRecapFile(i)" title="Remove file">✕</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <button class="action-button" (click)="generateRecap()" [disabled]="runningContext || recapContextFiles.length === 0">Generate Recap</button>

        <div class="form-group">
          <div class="textarea-header">
            <label for="recap">Generated Recap</label>
            <div class="font-size-controls">
              <button type="button" class="mode-toggle-btn" (click)="toggleRecapMode()" title="Toggle read/edit mode">
                {{ recapReadMode ? 'Read Mode' : 'Write Mode' }}
              </button>
              <button type="button" class="font-size-btn" (click)="adjustRecapFontSize(-1)" title="Decrease font size">A-</button>
              <span class="font-size-display">{{ recapFontSize }}px</span>
              <button type="button" class="font-size-btn" (click)="adjustRecapFontSize(1)" title="Increase font size">A+</button>
            </div>
          </div>
          <textarea *ngIf="!recapReadMode" id="recap" [(ngModel)]="recap" rows="8" placeholder="Recap will appear here..." [style.font-size.px]="recapFontSize"></textarea>
          <div *ngIf="recapReadMode" class="markdown-view" [innerHTML]="formatMarkdown(recap)" [style.font-size.px]="recapFontSize"></div>
        </div>
    </app-subsection>
  </div>
</div>

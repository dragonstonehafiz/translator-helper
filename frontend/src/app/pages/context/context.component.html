<div class="page-container">
  <div class="header-container">
    <h1>Context</h1>
    <app-tooltip-icon tooltip="Upload a subtitle file (.ass or .srt) and the app will automatically use the selected OpenAI API to generate context for translations"></app-tooltip-icon>
  </div>

  <div class="form-section">
    <app-subsection
      title="Import Context JSON"
      tooltip="Import a saved context JSON to populate all fields on this page">
      <p class="import-context-subtext">Drop a context file here to load languages, character list, synopsis, summary, and recap.</p>
      <app-file-upload
        accept=".json"
        placeholder="Import Context File"
        subtext=".json"
        [selectedFiles]="importFile ? [importFile] : []"
        (filesSelected)="onImportFilesSelected($event)">
      </app-file-upload>
    </app-subsection>

    <app-subsection 
      title="Recap Generation" 
      [collapsed]="recapCollapsed"
      tooltip="Generate a comprehensive recap from multiple context files for continuity across episodes">
      
      <app-file-upload
        accept=".json"
        [multiple]="true"
        placeholder="Upload Context Files"
        subtext=".json files (select multiple)"
        [selectedFiles]="recapContextFiles"
        (filesSelected)="onRecapFilesSelected($event)">
      </app-file-upload>

      <div class="file-table-container" *ngIf="recapContextFiles.length > 0">
        <div class="file-table-header">
          <span>Uploaded Context Files</span>
          <app-tooltip-icon tooltip="Files are processed in the order shown. Use ↑/↓ buttons to reorder them for proper chronological sequence."></app-tooltip-icon>
        </div>
        <table class="file-table">
          <thead>
            <tr>
              <th class="col-reorder"></th>
              <th class="col-index">#</th>
              <th class="col-filename">Filename</th>
              <th class="col-remove"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let file of recapContextFiles; let i = index">
              <td class="col-reorder">
                <div class="reorder-buttons">
                  <button type="button" 
                          class="reorder-btn" 
                          (click)="moveRecapFileUp(i)" 
                          [disabled]="i === 0"
                          title="Move up">↑</button>
                  <button type="button" 
                          class="reorder-btn" 
                          (click)="moveRecapFileDown(i)" 
                          [disabled]="i === recapContextFiles.length - 1"
                          title="Move down">↓</button>
                </div>
              </td>
              <td class="col-index">{{ i + 1 }}</td>
              <td class="col-filename">{{ file.name }}</td>
              <td class="col-remove">
                <button type="button" class="remove-btn" (click)="removeRecapFile(i)" title="Remove file">✕</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="action-button" (click)="generateRecap()" [disabled]="runningLlm || recapContextFiles.length === 0">Generate Recap</button>

      <div class="form-group">
        <app-text-field 
          label="Generated Recap" 
          placeholder="Recap will appear here..."
          [(ngModel)]="recap">
        </app-text-field>
      </div>
    </app-subsection>

    <app-subsection
      title="Context Generation"
      tooltip="Choose languages and upload subtitles for context generation">
      <div class="form-row">
        <div class="form-group">
          <div class="label-container">
            <label for="inputLanguage">Input Language</label>
          </div>
          <select id="inputLanguage" [(ngModel)]="inputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>

        <div class="form-group">
          <div class="label-container">
            <label for="outputLanguage">Output Language</label>
          </div>
          <select id="outputLanguage" [(ngModel)]="outputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
      </div>

      <app-file-upload
        accept=".ass,.srt"
        placeholder="Upload Subtitle File"
        subtext=".ass / .srt"
        [selectedFiles]="selectedFile ? [selectedFile] : []"
        (filesSelected)="onSubtitleFilesSelected($event)">
      </app-file-upload>

      <hr class="context-divider">

      <div class="context-tabs">
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'character'"
                (click)="setContextTab('character')">Character List</button>
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'synopsis'"
                (click)="setContextTab('synopsis')">Synopsis</button>
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'summary'"
                (click)="setContextTab('summary')">Summary</button>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'character'">
        <div class="form-group">
          <app-text-field 
            label="Character List" 
            tooltip="Generate a list of characters with descriptions from the subtitle file"
            placeholder="Enter character names and descriptions..."
            [(ngModel)]="characterList"
            (ngModelChange)="updateCharacterList()">
          </app-text-field>
        </div>

        <div class="context-options context-options--empty">
          <label class="checkbox-label">
            <input type="checkbox" disabled>
            <span>No options available</span>
          </label>
        </div>

        <button class="action-button" (click)="generateCharacterList()" [disabled]="runningLlm">Generate Character List</button>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'synopsis'">
        <div class="form-group">
          <app-text-field 
            label="Synopsis" 
            tooltip="Generate a synopsis of the episode or scene"
            placeholder="Enter synopsis..."
            [(ngModel)]="synopsis"
            (ngModelChange)="updateSynopsis()">
          </app-text-field>
        </div>

        <div class="context-options">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="synopsisUseCharacterList">
            <span>Include Character List</span>
          </label>
        </div>
        <button class="action-button" (click)="generateSynopsis()" [disabled]="runningLlm">Generate Synopsis</button>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'summary'">
        <div class="form-group">
          <app-text-field 
            label="Summary" 
            tooltip="Generate a high-level summary of the episode or content"
            placeholder="Enter summary..."
            [(ngModel)]="summary"
            (ngModelChange)="updateSummary()">
          </app-text-field>
        </div>

        <div class="context-options">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="summaryUseCharacterList">
            <span>Include Character List</span>
          </label>
        </div>
        <button class="action-button" (click)="generateSummary()" [disabled]="runningLlm">Generate Summary</button>
      </div>

      <hr class="context-divider">
      <app-context-status
        [characterList]="characterList"
        [synopsis]="synopsis"
        [summary]="summary"
        [recap]="recap">
      </app-context-status>
      <button class="action-button"
              (click)="exportContext()"
              [disabled]="!hasAnyContextContent()">
        Export Context
      </button>
    </app-subsection>
  </div>
</div>

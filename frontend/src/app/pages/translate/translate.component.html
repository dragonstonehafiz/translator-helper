<div class="page-container">
  <div class="header-container">
    <h1>Translate</h1>
    <app-tooltip-icon tooltip="Translate text and subtitle files"></app-tooltip-icon>
  </div>

  <div class="form-section">
    <app-subsection 
      title="Context" 
      [collapsed]="contextCollapsed"
      tooltip="Saved context from the Context page">

      <app-context-status
        [characterList]="characterList"
        [synopsis]="synopsis"
        [summary]="summary"
        [recap]="recap"
        [additionalInstructions]="additionalInstructions">
      </app-context-status>

      <div class="context-tabs">
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'additional'"
                (click)="setContextTab('additional')">Additional Instructions</button>
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'character'"
                (click)="setContextTab('character')">Character List</button>
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'synopsis'"
                (click)="setContextTab('synopsis')">Synopsis</button>
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'summary'"
                (click)="setContextTab('summary')">Summary</button>
        <button type="button"
                class="context-tab"
                [class.active]="activeContextTab === 'recap'"
                (click)="setContextTab('recap')">Recap</button>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'additional'">
        <app-text-field 
          label="Additional Instructions" 
          placeholder="No additional instructions available..."
          [rows]="6"
          [(ngModel)]="additionalInstructions">
        </app-text-field>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'character'">
        <app-text-field 
          label="Character List" 
          placeholder="No character list available..."
          [rows]="6"
          [(ngModel)]="characterList">
        </app-text-field>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'synopsis'">
        <app-text-field 
          label="Synopsis" 
          placeholder="No synopsis available..."
          [rows]="6"
          [(ngModel)]="synopsis">
        </app-text-field>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'summary'">
        <app-text-field 
          label="Summary" 
          placeholder="No summary available..."
          [rows]="6"
          [(ngModel)]="summary">
        </app-text-field>
      </div>

      <div class="context-tab-content" *ngIf="activeContextTab === 'recap'">
        <app-text-field 
          label="Recap" 
          placeholder="No recap available..."
          [rows]="6"
          [(ngModel)]="recap">
        </app-text-field>
      </div>
    </app-subsection>

    <app-subsection 
      title="Translate Line" 
      [collapsed]="translateLineCollapsed"
      tooltip="Translate a single line of text">
      
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="lineUseAdditionalInstructions">
          <span>Additional Instructions</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="lineUseCharacterList">
          <span>Character List</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="lineUseSynopsis">
          <span>Synopsis</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="lineUseSummary">
          <span>Summary</span>
        </label>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="lineInputLanguage">Input Language</label>
          <select id="lineInputLanguage" [(ngModel)]="lineInputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
        <div class="form-group">
          <label for="lineOutputLanguage">Output Language</label>
          <select id="lineOutputLanguage" [(ngModel)]="lineOutputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
      </div>

      <div class="translate-field-wrapper" [class.is-loading]="isTranslatingLine">
        <app-text-field 
          label="Text to Translate" 
          placeholder="Enter text to translate..."
          [rows]="4"
          [readMode]="false"
          [(ngModel)]="lineTextToTranslate">
        </app-text-field>
        <div class="translate-field-overlay" *ngIf="isTranslatingLine">
          <app-loading-text-indicator text="Translating Line..." color="#667eea" size="1.2rem"></app-loading-text-indicator>
        </div>
      </div>

      <app-primary-button [fullWidth]="true" (click)="translateLine()" [disabled]="!lineTextToTranslate || isTranslatingLine">
        {{ isTranslatingLine ? 'Translating...' : 'Translate Line' }}
      </app-primary-button>

      <app-text-field 
        label="Translation Result" 
        placeholder="Translation will appear here..."
        [rows]="4"
        [(ngModel)]="lineTranslationResult">
      </app-text-field>
    </app-subsection>

    <app-subsection 
      title="Translate File" 
      [collapsed]="translateFileCollapsed"
      tooltip="Translate an entire subtitle file">
      
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="fileUseAdditionalInstructions">
          <span>Additional Instructions</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="fileUseCharacterList">
          <span>Character List</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="fileUseSynopsis">
          <span>Synopsis</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="fileUseSummary">
          <span>Summary</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="fileUseRecap">
          <span>Recap</span>
        </label>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="fileInputLanguage">Input Language</label>
          <select id="fileInputLanguage" [(ngModel)]="fileInputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
        <div class="form-group">
          <label for="fileOutputLanguage">Output Language</label>
          <select id="fileOutputLanguage" [(ngModel)]="fileOutputLanguage">
            <option *ngFor="let lang of languageOptions" [value]="lang.code">{{ lang.name }} ({{ lang.code }})</option>
          </select>
        </div>
      </div>

      <div class="form-row context-info-row">
        <div class="form-group context-window-group">
          <label for="batchSize">
            Batch Size
            <app-tooltip-icon tooltip="Controls how many subtitle lines are translated per request. Larger batch sizes reduce the number of inference calls and are usually faster overall, but each batch may take longer and be more error-prone. Smaller batch sizes mean more calls, which is usually slower overall and can reduce context across lines."></app-tooltip-icon>
          </label>
          <input type="number" id="batchSize" [(ngModel)]="batchSize" min="1" max="10">
        </div>
        <div class="file-info-panel">
          <div class="file-info-heading">File Details</div>
          <div *ngIf="isFetchingFileInfo" class="file-info-status">Analyzing file...</div>
          <ng-container *ngIf="!isFetchingFileInfo">
            <div *ngIf="fileInfo; else fileInfoStatus" class="file-info-grid">
              <div>
                <span class="info-label">Lines</span>
                <span class="info-value">{{ fileInfo.totalLines }}</span>
              </div>
              <div>
                <span class="info-label">Characters</span>
                <span class="info-value">{{ fileInfo.characterCount }}</span>
              </div>
              <div>
                <span class="info-label">Average Characters per Line</span>
                <span class="info-value">{{ fileInfo.averageCharacterCount }}</span>
              </div>
            </div>
            <ng-template #fileInfoStatus>
              <div class="file-info-status" *ngIf="fileInfoError; else fileInfoPrompt">
                {{ fileInfoError }}
              </div>
              <ng-template #fileInfoPrompt>
                <div class="file-info-status">Upload a file to view stats.</div>
              </ng-template>
            </ng-template>
          </ng-container>
        </div>
      </div>

      <app-file-upload
        accept=".ass,.srt"
        placeholder="Upload Subtitle File"
        subtext=".ass / .srt"
        [selectedFiles]="fileToTranslate ? [fileToTranslate] : []"
        (filesSelected)="onFileSelected($event)">
      </app-file-upload>

      <app-primary-button [fullWidth]="true" (click)="translateFile()" [disabled]="!fileToTranslate || isTranslatingFile">
        {{ isTranslatingFile ? 'Translating...' : 'Translate File' }}
      </app-primary-button>

      <app-progress-bar
        *ngIf="fileTranslationProgress.total > 0"
        [current]="fileTranslationProgress.current"
        [total]="fileTranslationProgress.total"
        [avgSecondsPerLine]="fileTranslationProgress.avg_seconds_per_line"
        [etaSeconds]="fileTranslationProgress.eta_seconds">
      </app-progress-bar>

      <app-downloads-list
        [files]="availableDownloads"
        [isLoading]="isFetchingDownloads"
        [error]="downloadError"
        [deletingFilename]="deletingDownload"
        (refresh)="refreshDownloads()"
        (download)="downloadTranslatedFile($event)"
        (delete)="deleteTranslatedFile($event)">
      </app-downloads-list>
    </app-subsection>
  </div>
</div>
